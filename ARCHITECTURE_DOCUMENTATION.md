# Obsidian Projects Plugin - Архитектурная документация

## Обзор проекта

**Obsidian Projects** - это плагин для Obsidian, предназначенный для управления проектами на основе заметок. Плагин позволяет создавать проекты из папок и Dataview запросов, переключаться между четырьмя различными представлениями (Table, Board, Calendar, Gallery) и настраивать шаблоны заметок для каждого проекта.

### Ключевые принципы дизайна:
- **Leave no trace**: Плагин не оставляет специфичных конфигураций в заметках
- **Keep it native**: Выглядит и работает как нативная часть Obsidian
- **Stability over features**: Стабильность важнее новых функций

## Техническая архитектура

### 1. Система сборки

**Основные инструменты:**
- **esbuild** - основной бандлер для сборки
- **TypeScript** - язык программирования
- **Svelte** - фреймворк для UI компонентов
- **SASS** - препроцессор CSS

**Конфигурация сборки (`esbuild.config.mjs`):**
```javascript
// Основные настройки:
- entryPoints: ["./src/main.ts"]
- format: "cjs" (CommonJS)
- target: "es2016"
- external: ["obsidian", "electron", "@codemirror/*", ...builtins]
- plugins: [esbuildSvelte, replace]
```

**Скрипты сборки:**
- `npm run dev` - разработка с watch режимом
- `npm run build` - продакшн сборка
- `npm run sass-build` - компиляция SASS
- `npm run test` - запуск тестов

### 2. Структура проекта

```
src/
├── main.ts                    # Точка входа плагина
├── obsidianProjects.d.ts     # TypeScript декларации
├── lib/                      # Основная логика
│   ├── dataApi.ts           # API для работы с данными
│   ├── obsidian.ts          # Утилиты для Obsidian
│   ├── datasources/         # Источники данных
│   ├── dataframe/           # Модель данных
│   ├── filesystem/          # Файловая система
│   ├── metadata/            # Работа с метаданными
│   ├── stores/              # Svelte stores
│   └── templates/           # Шаблоны
├── ui/                      # Пользовательский интерфейс
│   ├── app/                 # Главное приложение
│   ├── components/          # Переиспользуемые компоненты
│   ├── modals/              # Модальные окна
│   ├── settings/            # Настройки
│   └── views/               # Представления данных
└── settings/                # Конфигурация и настройки
```

### 3. Основные модули

#### 3.1 Главный модуль (`main.ts`)

**Класс `ProjectsPlugin`** - основной класс плагина, наследуется от `Plugin`:

**Ключевые методы:**
- `onload()` - инициализация плагина
- `onunload()` - очистка ресурсов
- `loadSettings()` - загрузка настроек
- `activateView()` - активация представления
- `ensureCommands()` - управление командами

**Функциональность:**
- Регистрация иконки в ribbon
- Создание команд для Command Palette
- Контекстное меню для папок
- Управление представлениями (views)
- Интеграция с файловой системой

#### 3.2 API данных (`dataApi.ts`)

**Класс `DataApi`** - основной API для работы с данными:

**Методы:**
- `updateRecord()` - обновление записи
- `updateRecords()` - массовое обновление
- `addField()` - добавление поля
- `renameField()` - переименование поля
- `deleteField()` - удаление поля
- `createNote()` - создание заметки
- `deleteRecord()` - удаление записи

**Особенности:**
- Использует функциональное программирование (fp-ts)
- Работает с frontmatter заметок
- Поддерживает шаблоны
- Обрабатывает ошибки через Either

#### 3.3 Источники данных (`datasources/`)

**Абстрактный класс `DataSource`:**
```typescript
abstract class DataSource {
  abstract queryAll(): Promise<DataFrame>
  abstract queryOne(file: IFile, fields: DataField[]): Promise<DataFrame>
  abstract includes(path: string): boolean
  readonly(): boolean
}
```

**Реализованные источники:**

1. **FolderDataSource** - папки
   - Поддерживает рекурсивный поиск
   - Исключение определенных файлов
   - Работа с путями

2. **DataviewDataSource** - Dataview запросы
   - Интеграция с Dataview API
   - Парсинг результатов запросов
   - Read-only режим

3. **TagDataSource** - теги
   - Фильтрация по тегам
   - Наследует от FrontMatterDataSource

4. **FrontMatterDataSource** - базовый класс
   - Работа с frontmatter
   - Автоматическое определение схемы
   - Обработка ошибок

#### 3.4 Модель данных (`dataframe/`)

**Основные типы:**
```typescript
interface DataFrame {
  fields: DataField[]
  records: DataRecord[]
  errors?: RecordError[]
}

interface DataField {
  name: string
  type: DataFieldType
  repeated?: boolean
  derived?: boolean
  typeConfig?: any
}

interface DataRecord {
  id: string
  values: Record<string, DataValue>
}
```

**Типы полей:**
- String, Number, Boolean, Date, List, Link, File, Image

### 4. Пользовательский интерфейс

#### 4.1 Архитектура UI

**Основа:** Svelte компоненты с TypeScript

**Структура:**
- `ui/app/` - главное приложение
- `ui/components/` - переиспользуемые компоненты
- `ui/views/` - представления данных
- `ui/modals/` - модальные окна
- `ui/settings/` - настройки

#### 4.2 Представления (Views)

**Базовый класс `ProjectView`:**
```typescript
abstract class ProjectView<T = any> {
  abstract getViewType(): string
  abstract getDisplayName(): string
  abstract getIcon(): string
  abstract onData(result: DataQueryResult): Promise<void>
  abstract onOpen(props: ProjectViewProps<T>): Promise<void>
  abstract onClose(): Promise<void>
}
```

**Реализованные представления:**

1. **TableView** - табличное представление
   - Редактируемая сетка данных
   - Настройка колонок
   - Сортировка и фильтрация
   - Drag & drop

2. **BoardView** - канбан доска
   - Группировка по статусу
   - Drag & drop между колонками
   - Настройка колонок
   - Синхронизация порядка
   - Закрепление колонок (pin) и «Заморозка всех столбцов» (freeze all)

3. **CalendarView** - календарное представление
   - Отображение по датам
   - Навигация по месяцам
   - Цветовое кодирование

4. **GalleryView** - галерея
   - Карточки с изображениями
   - Настраиваемые поля
   - Адаптивная сетка

5. **DeveloperView** - для разработчиков
   - Тестирование компонентов
   - Демонстрация UI элементов

#### 4.3 Компоненты

**Основные компоненты:**
- `DataGrid` - таблица данных
- `Board` - канбан доска
- `Calendar` - календарь
- `Gallery` - галерея
- `Accordion`, `Box`, `Card` - базовые компоненты
- `Field`, `FieldControl` - поля ввода
- `TagList`, `TagsInput` - работа с тегами

### 5. Управление состоянием

#### 5.1 Svelte Stores

**Основные stores:**
- `settings` - настройки плагина
- `api` - API для работы с данными
- `i18n` - интернационализация
- `app`, `plugin` - ссылки на Obsidian объекты

#### 5.2 Настройки

**Версионирование настроек:**
- v1 - базовая версия
- v2 - текущая версия с архивами

**Структура настроек:**
```typescript
interface ProjectsPluginSettings {
  version: 2
  projects: ProjectDefinition[]
  archives: ProjectDefinition[]
  preferences: ProjectsPluginPreferences
}
```

**Миграция настроек:**
- Автоматическая миграция между версиями
- Обратная совместимость
- Валидация данных

### 6. Интеграция с Obsidian

#### 6.1 API интеграция

**Используемые API:**
- `Plugin` - базовый класс плагина
- `App` - основное приложение
- `Vault` - файловая система
- `Workspace` - рабочее пространство
- `TFile`, `TFolder` - файлы и папки

#### 6.2 События

**Обработка событий:**
- Изменения файлов
- Создание/удаление файлов
- Переименование файлов
- Изменения в папках

#### 6.3 Команды

**Регистрируемые команды:**
- `show-projects` - показать проекты
- `create-project` - создать проект
- `create-note` - создать заметку
- Динамические команды для проектов и представлений

### 7. Зависимости

#### 7.1 Основные зависимости

**Runtime:**
- `obsidian` - API Obsidian
- `obsidian-dataview` - интеграция с Dataview
- `svelte` - UI фреймворк
- `dayjs` - работа с датами
- `uuid` - генерация ID
- `immer` - иммутабельные обновления
- `fp-ts` - функциональное программирование

**Development:**
- `typescript` - типизация
- `esbuild` - сборка
- `jest` - тестирование
- `eslint` - линтинг
- `prettier` - форматирование
- `sass` - стили

#### 7.2 UI библиотеки

**obsidian-svelte** - компоненты для Obsidian:
- Базовые компоненты (Button, Input, etc.)
- Специализированные (FileAutocomplete, etc.)
- Иконки и утилиты

### 8. Файловая система

#### 8.1 Абстракция файловой системы

**Интерфейс `IFileSystem`:**
```typescript
interface IFileSystem {
  getAllFiles(): IFile[]
  getFile(path: string): IFile | null
  create(path: string, content: string): Promise<IFile>
}
```

**Реализации:**
- `ObsidianFileSystemWatcher` - для Obsidian
- `InMemoryFileSystem` - для тестов

#### 8.2 Работа с файлами

**Интерфейс `IFile`:**
```typescript
interface IFile {
  path: string
  read(): Promise<string>
  write(content: string): Promise<void>
  delete(): Promise<void>
}
```

### 9. Интернационализация

**Поддерживаемые языки:**
- English (en.json)
- Ukrainian (uk.json)
- Chinese Simplified (zh-CN.json)

**Использование:**
- Svelte store `i18n`
- Функция `t()` для переводов
- Автоматическое определение языка

### 10. Тестирование

**Инструменты:**
- Jest - основной фреймворк
- esbuild-jest - интеграция с esbuild
- Моки для Obsidian API

**Покрытие:**
- Модульные тесты для утилит
- Тесты для источников данных
- Тесты для метаданных

## Рекомендации для улучшения

### Технические улучшения:

1. **Производительность:**
   - Виртуализация для больших таблиц
   - Ленивая загрузка данных
   - Кэширование запросов

2. **Архитектура:**
   - Разделение на микросервисы
   - Улучшение типизации
   - Рефакторинг legacy кода

3. **UI/UX:**
   - Современный дизайн
   - Улучшенная доступность
   - Адаптивность

4. **Функциональность:**
   - Новые типы представлений
   - Расширенная фильтрация
   - Экспорт/импорт данных

### Дизайнерские улучшения:

1. **Визуальный дизайн:**
   - Обновление цветовой схемы
   - Современные иконки
   - Улучшенная типографика

2. **Пользовательский опыт:**
   - Упрощение навигации
   - Контекстные подсказки
   - Быстрые действия

3. **Адаптивность:**
   - Мобильная версия
   - Планшетная оптимизация
   - Темная/светлая темы

Этот документ предоставляет полное понимание архитектуры плагина Obsidian Projects и может служить основой для дальнейшей разработки и улучшений.

## Дизайн-гайд: «Улучшение восприятия, сохранение функционала»

Этот раздел фиксирует обязательные правила и процесс для визуальных изменений UI. Цель — сделать интерфейс современным и интуитивным, не меняя механики данных и бизнес-логику.

### Принципы

- Form Follows Function (Форма следует за функцией)
  - Сначала изучаем функции и сценарии использования; визуальные изменения подчёркивают существующие действия.
  - Не удаляем и не переносим элементы без прямого и понятного аналога.
  - Редактируемые зоны помечаем мягкими подсказками (например, иконка карандаша при hover).

- Наслоение знания (Layering of Information)
  - Ключевые данные (статус, сроки, теги, связи) — на первом экране карточки/колонки.
  - Иерархия через размер/вес/цвет шрифта; второстепённые данные по клику/hover с явной подсказкой.

- Невидимые направляющие (Invisible Guides)
  - Единая система цвета (срочность, контекст), мини‑иконки действий, деликатные разделители.
  - Поток взгляда слева→направо, сверху→вниз; элементы выровнены и визуально рифмуются.

- Консистентность с экосистемой Obsidian
  - Типографика, отступы, контролы — в духе Obsidian; поддержка светлой/тёмной тем.
  - Избегаем «ломающих» кастомных паттернов.

- Обратная связь и отзывчивость (Feedback & Responsiveness)
  - Состояния hover/focus/active видимы; действия дают подтверждение (галочка, подсветка).
  - Адаптивная вёрстка: десктоп → планшет → мобильный, без потери функций.

### Процесс принятия изменений

1) Исследование функции
   - Короткое описание задачи пользователя и текущего сценария.
   - Идентификация точек риска (пример: уменьшение видимости кнопки «Добавить»).

2) Предложение варианта(ов)
   - Вариант A (минимальный): улучшение визуала без перемещения/скрытия элементов.
   - Вариант B (улучшение размещения): перенос с полным функциональным аналогом и явной подсказкой.

3) Анализ «точек отказа» и зависимостей
   - Возможные конфликты с существующей логикой (DnD, фильтры, шаблоны, Dataview).
   - Решение зависимостей: альтернатива, смягчение риска или отказ от изменения.

4) Проверка совместимости
   - Светлая/тёмная темы, локализации, масштабирование, доступность.

5) Внедрение
   - Только стили/верстка/микровзаимодействия; без изменений моделей данных и API.
   - Без скрытия действий «за жестами» без текста/иконки/tooltip.

6) Контроль стабильности
   - Визуальные регрессии в Table/Board/Calendar/Gallery и тулбарах.

### Чек‑лист перед слиянием

- Не изменены контракты данных и поведение источников/хранилищ.
- Элемент, который стал менее заметен, получил альтернативную подсказку.
- Видимость состояний (hover/focus/active) проверена.
- Контраст достаточен в обеих темах.
- Никаких блокеров для клавиатуры/экранных читалок добавлено не было.

### Текущее соответствие и расхождения (октябрь 2025)

- Соответствие
  - Board: у карточек уже есть плавные hover/поднятие и тени (`CardList.svelte`).
  - Заголовки колонок показывают действия по hover (`ColumnHeader.svelte`).

- Расхождения/обрывки
  - Нет явной «подсказки редактирования» на редактируемых полях карточек.
  - В `events.ts` используется временный «хак» для обновления Dataview по изменению файла.
  - В `FilterOptions.svelte` — исправлено: добавлена безопасная конверсия значения при смене типа оператора и улучшены плейсхолдеры/подсказки.
  - In‑memory FS (`inmem/filesystem.ts`) — исправлено: реализован `readTags()` (inline `#tags` и фронтматтер `tags`/`tag`).

План устранения расхождений:
- Добавить мягкие иконки‑подсказки редактирования в редактируемых местах.
- Заменить «хак» на явный сигнал `refresh` источнику Dataview (или событие в store).
- Проверить контраст и поведение в светлой/тёмной темах для новых подсказок и инпутов.

## Новые функции и изменения (октябрь 2025)

### Улучшения доски (Board)
- Добавлено разделение колонок на закреплённые и обычные: закреплённые фиксируются и не участвуют в DnD; карточки в них не перетаскиваются и не принимают карточки из других колонок.
- Добавлена глобальная опция «Заморозить все столбцы»: при активировании все колонки считаются закреплёнными.
- Конфигурация:
  - `BoardConfig.freezeAll?: boolean` — глобальная заморозка столбцов.
  - Закрепление отдельных колонок хранится в `fieldConfig.options` для поля группировки (как и ранее).

Точки изменений:
- `src/ui/views/Board/components/Board/Board.svelte` — раздельный рендер закреплённых и обычных колонок; отключение DnD для закреплённых.
- `src/ui/views/Board/components/Board/CardList.svelte` — флаг `disableDnd` для блокировки DnD карточек.
- `src/ui/views/Board/components/Board/BoardColumn.svelte` — прокидывание `disableDnd` в списки карточек закреплённых колонок.
- `src/ui/views/Board/BoardView.svelte` — принудительная установка `pinned` при `freezeAll`.
- `src/ui/views/Board/types.ts` — новое поле `freezeAll` в `BoardConfig`.

### Улучшения тулбаров и UX
- Убраны текстовые метки с кнопок тулбара (`Color`, `Filter`, `Sort` и кнопок выбора вида), чтобы сделать интерфейс более чистым и минималистичным. Остались только иконки.
- Единое выравнивание кнопок тулбаров по левой стороне.
- Добавлена кнопка сворачивания/разворачивания панели инструментов (chevron up/down) во всех тулбарах. При сворачивании панель сжимается, а кнопка управления перемещается в левый верхний угол, освобождая вертикальное пространство для основного контента.

Точки изменений:
- `src/ui/components/Layout/ViewToolbar.svelte` —
  - выравнивание контейнера `justify-content: flex-start`;
  - добавлена логика сворачивания/разворачивания (`collapsed` state);
  - при сворачивании контейнер сжимается, а кнопка `.toggle` позиционируется абсолютно в левом верхнем углу;
  - видимая кнопка сворачивания; скрытие секций `left`, `middle`, `right`, `info` при коллапсе;
  - исправление разметки слотов (обёртка `<div class="info">` вместо директив на `<slot>`).
- `src/ui/app/toolbar/viewOptions/PopoverButton.svelte` и `src/ui/app/toolbar/ViewItem.svelte` — убраны текстовые метки (`label`).
- Все места использования `ViewToolbar` (Table/Board/Gallery/Calendar/главный Toolbar) автоматически унаследовали изменения.

### Сборка
- Сборка проходит успешно; остались только A11y-предупреждения из внешних зависимостей, на работу они не влияют.

### UX-акценты и консистентность
- Карточки: при наведении появляется кнопка редактирования (иконка «pencil») с локализованным тултипом; hover/focus не меняют механику.
- Фильтры: безопасная конверсия значений при смене типа оператора; плейсхолдеры и tooltip у селектов.
- In‑memory FS: поддержка чтения тегов для соответствия продакшен‑логике.
- Dataview: явный метод `refresh()` вместо пересета стора.
- Тематическая совместимость: новые стили используют системные CSS‑переменные Obsidian (`--background-*`, `--interactive-accent`, `--background-modifier-*`) и сохраняют контраст в светлой/тёмной темах.
