import type { App, Command } from "obsidian";
import type { ProjectDefinition, ShowCommand } from "../settings/settings";

const PROJECTS_PLUGIN_ID = "obs-projects-plus";

export class CommandManager {
  private app: App;
  private pluginId: string;

  constructor(app: App) {
    this.app = app;
    this.pluginId = PROJECTS_PLUGIN_ID;
  }

  /**
   * Ensures all commands are properly registered based on current settings
   * Synchronizes enabled and registered show commands for individual views and projects
   */
  ensureCommands(
    enabledCommands: ShowCommand[],
    projects: ProjectDefinition[]
  ): void {
    const registeredCommandIds = this.getRegisteredCommandIds();
    
    this.removeRedundantCommands(enabledCommands, projects, registeredCommandIds);
    this.addMissingCommands(enabledCommands, projects, registeredCommandIds);
  }

  /**
   * Gets all currently registered project commands
   */
  private getRegisteredCommandIds(): Set<string> {
    return new Set<string>(
      Object.keys(this.app.commands.commands).filter((id) =>
        id.startsWith(`${this.pluginId}:show:`)
      )
    );
  }

  /**
   * Removes commands that are no longer needed (disabled or deleted)
   */
  private removeRedundantCommands(
    enabledCommands: ShowCommand[],
    projects: ProjectDefinition[],
    registeredCommandIds: Set<string>
  ): void {
    registeredCommandIds.forEach((id) => {
      const enabledCommand = enabledCommands.find(
        (command) => id === this.getShowCommandId(command, true)
      );

      // Unregister command if it's been disabled
      if (!enabledCommand) {
        this.app.commands.removeCommand(id);
        return;
      }

      const project = this.findProjectForCommand(projects, enabledCommand);

      // Unregister command if its project/view has been deleted
      if (!project) {
        this.app.commands.removeCommand(id);
      }
    });
  }

  /**
   * Finds the project that corresponds to a specific show command
   */
  private findProjectForCommand(
    projects: ProjectDefinition[],
    command: ShowCommand
  ): ProjectDefinition | undefined {
    return projects.find((project) => {
      if (command.view) {
        return (
          project.id === command.project &&
          project.views.find((view) => view.id === command.view)
        );
      } else {
        return project.id === command.project;
      }
    });
  }

  /**
   * Registers new commands that are enabled but not yet registered
   */
  private addMissingCommands(
    enabledCommands: ShowCommand[],
    projects: ProjectDefinition[],
    registeredCommandIds: Set<string>
  ): void {
    enabledCommands.forEach((command) => {
      const globalId = this.getShowCommandId(command, true);
      const localId = this.getShowCommandId(command, false);

      if (registeredCommandIds.has(globalId)) {
        // Command has been both enabled and registered. All is well.
        return;
      }

      const project = projects.find(
        (project) => project.id === command.project
      );

      if (project) {
        this.registerProjectCommand(command, project, localId);
      }
    });
  }

  /**
   * Registers a command for a specific project and optionally view
   */
  private registerProjectCommand(
    command: ShowCommand,
    project: ProjectDefinition,
    localId: string
  ): void {
    if (command.view) {
      const view = project?.views.find((view) => view.id === command.view);

      if (view) {
        this.app.commands.addCommand({
          id: localId,
          name: `Show ${project.name} > ${view.name}`,
          callback: () => {
            this.activateView(project.id, view.id);
          },
        });
      }
    } else {
      this.app.commands.addCommand({
        id: localId,
        name: `Show ${project.name}`,
        callback: () => {
          this.activateView(project.id);
        },
      });
    }
  }

  /**
   * Gets the command identifier for a Show command
   *
   * A command id for Show commands has the following structure:
   * - show:<project-id>
   * - show:<project-id>:<view-id>
   *
   * If `global` is true, the plugin id is prepended to the command id:
   * - obs-projects-plus:show:<project-id>
   * - obs-projects-plus:show:<project-id>:<view-id>
   */
  private getShowCommandId(cmd: ShowCommand, global: boolean): string {
    const res: string[] = [];

    if (global) {
      res.push(this.pluginId);
    }

    res.push("show");

    if (cmd.project) {
      res.push(cmd.project);
    }
    if (cmd.view) {
      res.push(cmd.view);
    }

    return res.join(":");
  }

  /**
   * Activates a project view (placeholder - should be injected)
   * This will be connected to the main plugin's activateView method
   */
  private activateView(projectId?: string, viewId?: string): void {
    // This will be connected to the main plugin
    // We can't directly call it here without circular dependency
    throw new Error("activateView must be implemented by the calling context");
  }

  /**
   * Sets the activation function (called by main plugin)
   */
  setActivateViewFunction(activateViewFn: (projectId?: string, viewId?: string) => void): void {
    // Store the function for use in registerProjectCommand
    this.activateView = activateViewFn;
  }
}